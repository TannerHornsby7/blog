@use "./base";
@use "./variables.scss" as *;
@use "table";
@use "colors";

:root {
  --font-bad-handwriting: "BadHandwriting";
}

.explorer {
  text-align: center;

  & a {
    text-decoration: none;
  }

  & .visited {
    color: inherit;
  }
}

.popover dl,
.popover article {
  color: var(--dark);
}

// The <a> link back up to content is the last child of the <li>
li[id^="user-content-fn-"] > * {
  &:is(blockquote):nth-last-child(2) {
    margin-bottom: $base-margin;
  }

  &:not(blockquote):nth-last-child(2) {
    margin-bottom: 0; // Don't have unnecessary space before the <li>
  }
}

// Ensure not too much margin before blockquote
li > blockquote:first-child {
  margin-top: $base-margin;
}

.footnotes {
  & ul {
    margin-top: calc(2 * $base-margin);
  }

  & li {
    max-width: 100%;
  }

  // Ordered lists in footnotes should start at 1, 2, 3, etc.
  & li ol {
    counter-reset: list;

    & li {
      counter-increment: list;

      &::before {
        content: counter(list) ".";
      }
    }
  }
}

// Ensure that last ol of a li has no bottom margin
li[id^="user-content-fn-"] {
  & > ol {
    margin-block-end: 0;
  }

  & > p:last-child > a[class*="footnote-backref"]:last-child,
  & > a[class*="footnote-backref"]:last-child {
    display: inline-block; // Show the last backref
    color: color-mix(in srgb, var(--color-link) 70%, transparent);
    text-decoration: none;
    background-color: transparent;
    font-family: DejaVuSerifCondensed-Bold, serif;
    vertical-align: top;
  }
}

a[id*="fnref-"] {
  // When scrolling back to a footnote, scroll up farther than default
  scroll-margin-top: calc(2 * $base-margin);

  @media all and (max-width: $full-page-width) {
    scroll-margin-top: calc(7 * $base-margin);
  }

  // Footnotes should be a bit easier to see
  background-color: color-mix(in srgb, gray 10%, transparent);
  padding: 0 0.1rem;
  border-radius: 5px;
  line-height: var(--line-height);
}

em {
  font-style: italic;
  font-family: var(--font-text-italic);
}

ol,
ul {
  margin-block-end: calc(2 * $base-margin);
  padding-left: calc(3 * $base-margin);

  dl & {
    margin-top: calc(0.5 * $base-margin);
  }
}

dd > ul:first-child,
dd > ol:first-child {
  margin-top: 0;
}

dd {
  margin-block: 0 calc(2 * $base-margin);
  margin-top: 0;
  margin-bottom: calc(2 * $base-margin);

  & > p:first-child {
    margin-top: 0;
  }
}

.footnotes ol > li::before {
  margin-right: calc(0.25 * $base-margin);
}

ul li::marker {
  color: var(--gray);
}

ol {
  --li-margin: 4px; // Ensure list items are spaced more than just line-height
  & > li {
    counter-increment: list; // Increment the list counter for each list item
    list-style-type: none; // Remove default list item numbering
    margin-bottom: var(--li-margin);

    &::before {
      font-variant-numeric: lining-nums; // Use lining numbers for list items
      color: var(--gray);
      text-align: right;
      content: counters(list, ".") "."; // Display the list counter with periods
      margin-right: calc(0.5 * $base-margin);
      flex-shrink: 0;
    }

    // Nested lists
    & > ol {
      counter-reset: sublist; // Each nested ordered list has its own sublist counter
      margin-bottom: 0;
      margin-top: 0;

      li {
        counter-increment: sublist; // Increment the sublist counter for nested list items
        &::before {
          content: counters(list, ".") "." counters(sublist, "."); // Display combined list and sublist counters for nested list items
        }

        &:first-child {
          margin-top: var(--li-margin); // Remove top margin from the first nested list item
        }
      }
    }
  }

  // This comes in an h2 right before the footnotes.
  .footnote-label {
    counter-reset: footnote;
  }

  li[id^="user-content-fn-"] {
    // Target li elements whose id attribute value starts with 'user-content-fn-'
    display: block;
    counter-increment: footnote; // Increment the footnote counter for each matching li
    margin-bottom: $base-margin; // Add a bottom margin to the list items
    text-indent: 0;

    // Make the backref arrows look nice
    & .data-footnote-backref {
      color: color-mix(in srgb, var(--color-link) 70%, transparent);
      text-decoration: none;
      background-color: transparent;
      font-family: DejaVuSerifCondensed-Bold, serif;
      vertical-align: top;
    }

    & p:first-child {
      margin-top: 0; // Remove top margin from the first paragraph in the footnote
    }

    & p:last-child {
      margin-bottom: 0; // Remove top margin from the first paragraph in the footnote
    }

    &::before {
      margin-left: calc(-0.25 * $base-margin);
      vertical-align: baseline;
      font-size: var(--text-size-100);
      content: counter(footnote) "."; // Display the counter followed by a period
    }
  }
}

/* Set monospace font for code blocks, inline code, etc. */
code,
pre {
  font-family: var(--font-monospace);
  background-color: transparent;
  color: inherit;
  font-size: 0.81em;
}

// Adjust spacing around lists
p:has(+ ol),
p:has(+ ul) {
  margin-bottom: calc(1.5 * $base-margin);
}

/* Wrap links properly */
a {
  color: var(--color-link);
  white-space: normal;
  word-break: break-word;
  hyphens: auto;
  margin-top: 0;
  text-underline-offset: 2px; // Default underline too close to text

  // After you visit a link, it becomes less important that it stands out
  &:visited {
    color: color-mix(in srgb, currentcolor 50%, var(--color-link));
  }

  // Don't have anchor links with box behind them
  &[role="anchor"] {
    background-color: transparent;
  }

  &[id^="user-content-fnref-"] {
    text-decoration: none;
  }
}

.footnotes ul,
.footnotes ol {
  margin-top: $base-margin;
}

audio {
  width: 85%;
}

// Partially blends audio player with background
[saved-theme="dark"] audio {
  mix-blend-mode: luminosity;
}

sup {
  line-height: 0; // Don't push other lines away
}

.text-ornament {
  font-family: "EBGaramond12", serif;
  font-size: 3rem;
  filter: saturate(90%);
  color: var(--blue);
  opacity: light-dark(0.7, 0.7);
}

.trout-ornament {
  width: 3rem;
  margin-top: calc(2 * $base-margin);
  margin-bottom: calc(2 * $base-margin);
  filter: light-dark(none, invert(66%)) !important;
  opacity: light-dark(0.5, 1);
}

// Dark <-> Light
.temporary-transition *,
.temporary-transition .mermaid * {
  transition:
    background-color 1s ease-in-out,
    border-color 1s ease-in-out,
    fill 1s ease-in-out,
    stroke 1s ease-in-out !important;
}

// Hide video speed controller
.vsc-controller:has(+ img + video.no-vsc) {
  display: none;
}

:root[saved-theme="dark"] video,
:root[saved-theme="dark"] img {
  &.favicon {
    filter: saturate(0%);
  }

  & .invert {
    filter: grayscale(50%) invert(100%) brightness(95%) hue-rotate(180deg);
  }
}

body[data-slug="bruce-wayne-and-the-cost-of-inaction"] {
  & .header-img {
    filter: saturate(0%);
  }
}

/* Specific elements and features */
.gold-script {
  font-feature-settings: "swsh" 1;
  color: light-dark(#daa520, #ffd700); /* Gold */

  // Make it easier to see on light themes
  -webkit-text-stroke: 0.2px light-dark(black, transparent);
}

.bad-handwriting {
  font-family: var(--font-bad-handwriting);
  text-align: center;
  font-style: italic;
  font-size: 1.5em;
  margin-top: 1em;
  margin-bottom: 1em;
}

figure,
.subfigure {
  margin-inline: $base-margin $base-margin;
  margin-block: $base-margin $base-margin;

  & img {
    display: block;
    margin-left: auto;
    margin-right: auto;

    // margin-bottom: calc(0.75 * $base-margin);
  }

  & + figure {
    margin-top: calc(3 * $base-margin);
  }

  flex: 1 1 0px;
}

.article-title,
.page-listing-title {
  font-variant-numeric: lining-nums;
}

.article-title {
  margin: 2rem 0 0;

  @media all and (max-width: $full-page-width) {
    margin-top: $base-margin;
  }

  .popover & {
    margin-top: calc(1.5 * $base-margin) !important;
  }
}

.article-title:has(+ .subtitle),
h1:has(+ .subtitle),
h2:has(+ .subtitle),
h3:has(+ .subtitle),
h4:has(+ .subtitle),
h5:has(+ .subtitle),
h6:has(+ .subtitle),
p:has(+ .subtitle),
.callout-title:not(.is-collapsed *):has(+ .callout-content > .subtitle) {
  margin-bottom: 0;
}

.subtitle {
  color: var(--gray);
  margin-top: 0;
  font-size: var(--text-size-90);

  & .favicon {
    // Smaller favicon for smaller font
    --favicon-size: calc(pow(var(--scale-ratio), -1) * 0.65rem);

    width: var(--favicon-size);
    height: var(--favicon-size);
  }

  .callout & {
    color: color-mix(in srgb, var(--gray) 60%, var(--color));

    & a {
      color: inherit;
    }
  }
}

figure > img {
  z-index: -1;
}

figcaption {
  margin-top: calc(0.5 * $base-margin);
  position: relative;
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
}

img,
figcaption,
.float-right {
  text-align: center;
  color: var(--darkergray);
  font-size: var(--text-size-90); /* smaller than the surrounding text */
}

.float-right {
  margin: $base-margin calc(2 * $base-margin) calc($base-margin) calc(2 * $base-margin);

  & img,
  img.float-right {
    margin-left: auto;
    margin-right: auto;
    display: block;
  }

  float: right;
  max-width: 45%;
}

.small-caps {
  font-family: var(--font-text-sc);
  font-style: inherit;
  text-transform: lowercase;
  font-variant-caps: small-caps; // Fixes kerning in a few cases
  -webkit-font-smoothing: antialiased; // Prevent excess bolding

  &:visited {
    color: var(--color-visited);
  }

  dt &,
  b &,
  strong & {
    font-weight: 500 !important;
    -webkit-font-smoothing: none;
  }
}

.no-select {
  -webkit-user-drag: none;
  user-select: none;
}

/* Ensure favicons have appropriate properties. */
img.favicon {
  display: inline;
  width: 0.65rem;
  height: 0.65rem;
  margin-right: auto;
  vertical-align: 25%;
  filter: saturate(0%);
  margin-bottom: -0.07em;
  margin-top: -20%;
  mix-blend-mode: normal !important;

  // Make favicons align properly with headings
  h1 &,
  h2 &,
  h3 &,
  h4 &,
  h5 &,
  h6 & {
    vertical-align: 65%;
  }

  // These are really dark by default so we make them match var(--dark)
  &[src$="mail.svg"],
  &[src$="anchor.svg"],
  &[src$="readthesequences_com.avif"] {
    // Computed to match var(--dark) using https://codepen.io/sosuke/pen/Pjoqqp
    filter: invert(27%);

    :root[saved-theme="dark"] & {
      filter: invert(91%) sepia(6%) hue-rotate(185deg) contrast(92%);
    }
  }

  // Rotate the anchor so that it resembles the trout within-site icon
  // also flip it horizontally
  &[src$="anchor.svg"] {
    transform: rotate(-90deg) scaleX(-1) scale(1.2);
  }

  // Github should be lighter b/c starts off darker
  &[src$="github_com.avif"] {
    filter: invert(40%);

    :root[saved-theme="dark"] & {
      filter: invert(75%) sepia(6%) hue-rotate(185deg) contrast(92%);
    }
  }

  // Make NeurIPS logo white on dark mode
  &[src$="nips_cc.avif"] {
    filter: invert(100%);
  }

  &[src$="arbital_com.avif"],
  &[src$="aaai_org.avif"] {
    :root[saved-theme="light"] & {
      filter: brightness(0.3);
    }
  }

  // Gray logos made white on dark mode
  &[src$="alignmentforum_org.avif"],
  &[src$="ai-alignment_com.avif"] {
    :root[saved-theme="dark"] & {
      filter: brightness(3); // Make it brighter
    }
  }

  &[src$="turntrout-favicons/favicon.ico"] {
    // Light mode
    :root[saved-theme="light"] & {
      filter: contrast(15%);
    }

    // Dark mode
    :root[saved-theme="dark"] & {
      filter: invert(91%) sepia(6%) hue-rotate(185deg) brightness() contrast(50%);
    }
  }
}

.book-citation {
  font-style: italic;
}

.collapsible {
  & .collapsible-title {
    display: flex;

    & h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p {
      margin-top: 0;
      margin-bottom: 0;
    }
  }

  & .content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
  }
}

svg.fold-icon {
  --icon-size: 18px;

  display: inline-flex; /* Use inline-flex for better alignment */
  align-items: center;
  justify-content: center;
  margin: 0;
  margin-left: calc(0.5 * $base-margin);
  margin-top: 0.25rem;
  cursor: pointer;
  width: var(--icon-size);
  height: var(--icon-size);
  fill: var(--gray); /* Set the default color here */
  transition: transform 0.2s ease-out; /* Add a smooth transition */
  transform: rotate(-90deg); /* Initial 90-degree rotation */

  &[aria-expanded="true"] {
    transform: rotate(0deg); /* Rotate 180 degrees when expanded */
  }
}

// Tags section in the metadata
.tags {
  color: var(--gray);
  list-style: none;
  display: block;
  padding-left: 0;
  padding-right: $base-margin;
  overflow-wrap: normal;

  & a.tag-link {
    color: var(--gray);
    border-radius: 5px; /* Add rounded corners to the tags box */
    line-height: 1rem;
    padding: 0;
    padding-top: initial;
    padding-bottom: initial;
    background-color: transparent;
    display: block;
  }
}

hr {
  max-width: 97.5%; // Looks weird if it extends all the way to the right
  margin: calc(3 * $base-margin) 0;
}

.right {
  & h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  p,
  a,
  li {
    // Don't make popover text gray
    &:not(* .popover-inner *) {
      color: var(--gray);
    }
  }

  & #content-meta {
    font-size: var(--text-size-90);
    margin-bottom: 0;
  }
}

.authors {
  & p {
    color: var(--gray);

    & a {
      color: inherit;
    }

    margin-top: 0;

    &:not(:last-child) {
      margin-bottom: 0;
    }
  }

  & .publication-str {
    font-variant-numeric: lining-nums;
  }
}

img,
video {
  width: fit-content;
  max-width: 100%;
  margin-bottom: calc($base-margin);

  article > p &,
  article > &,
  article > figure &,
  figure > & {
    margin-left: auto;
    margin-right: auto;
    display: block;
  }
}

img {
  &.inline-img {
    display: inline;
    width: 0.9rem;
    vertical-align: middle;
    margin: 0;
    margin-left: 0.05rem;
    margin-right: 0.025rem;
    margin-bottom: 0.1rem;
  }

  margin-top: $base-margin;
}

// Ordering the z stacks
#left-sidebar {
  z-index: 1;
}

svg {
  margin-bottom: $base-margin;
}

body.no-mix-blend-mode {
  & img,
  & video,
  & svg {
    mix-blend-mode: normal;
  }

  & #search-layout {
    [saved-theme="light"] & img,
    [saved-theme="light"] & video,
    [saved-theme="light"] & svg {
      mix-blend-mode: multiply;
    }
  }
}

p > img {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

ol li,
ul li,
ol li[id^="user-content-fn"] {
  & p,
  & video,
  & table {
    display: block;
    margin-block: calc(2 * $base-margin);

    &:first-child {
      display: inline;
    }
  }
}

img.emoji {
  display: inline;
  border-radius: 0; // Don't want to cut off corners
  height: 1em;
  width: 1em;
  margin: 0 0.05em 0 0.1em;
  vertical-align: -0.1em;
  mix-blend-mode: normal !important;
}

#alex-rainbow-date-me {
  mix-blend-mode: normal;
  width: calc(min(60%, 50vw));
  max-width: 60%;
  margin-top: 0;
  margin-bottom: 0;

  @media all and (max-width: $mobile-breakpoint) {
    margin-right: 0;
    margin-left: $base-margin;
  }
}

.sequence-links {
  margin-bottom: calc(2 * $base-margin);
}

.sequence-links-divider {
  color: var(--lightgray);
  height: calc(8 * $base-margin);
  margin-top: calc(2 * $base-margin);
  margin-left: $base-margin;
  margin-right: $base-margin;
  border-left-style: solid;
  border-left-width: 1px;
}

.sequence-links-post-navigation {
  width: 45%;
}

.sequence-nav {
  display: flex;
  justify-content: space-between;

  & a {
    flex: 0 0 auto;
  }

  & .prev-post {
    margin-right: auto;
  }

  & .next-post {
    margin-left: auto;
  }
}

// Fixing issue where eqn numbers overlap with katex math
//  https://github.com/KaTeX/KaTeX/issues/3066
.katex-html {
  .base {
    margin: 0 auto;
  }
}

.vlist-r:last-of-type {
  // For some reason, the last one messes up katex sub on safari (eg https://turntrout.com/statistics-of-a-maze-solving-network#statistically-informed-impressions)
  display: none;
}

.katex-html:has(span.tag) {
  display: flex !important;
}

.katex-display > .katex > .katex-html > .tag {
  position: relative !important;
  float: right;
  margin-left: 0.25rem;
}

// Spoilers (remark-spoiler)
.spoiler-container {
  position: relative;
  cursor: pointer;
  width: fit-content;
}

.spoiler-overlay {
  position: absolute;
  height: 90%; // Visually center the overlay
  width: 100%;
  color: var(--dark);
  display: flex;
  align-items: center;
  justify-content: center;

  &::after {
    content: "Hover to show";
  }

  @media (max-width: $tablet-breakpoint) {
    &::after {
      content: "Tap to show";
    }
  }
}

.spoiler-content {
  filter: blur(4px);
  opacity: 0.5;

  // Safari needs this
  & > * {
    filter: inherit;
    opacity: inherit;
  }
}

.spoiler-container:hover .spoiler-overlay,
.spoiler-container:focus .spoiler-overlay,
.spoiler-container.revealed .spoiler-overlay {
  opacity: 0;
  pointer-events: none;
}

.spoiler-container:hover .spoiler-content,
.spoiler-container:focus .spoiler-content,
.spoiler-container.revealed .spoiler-content {
  filter: blur(0);
  opacity: 1;
}

// For usage in the middle of a paragraph
.dropcap {
  // The background glyph
  font-family: "EBGaramondInitialsF1", serif;
  color: var(--lightgray);
  position: relative;
  text-transform: uppercase;
  margin-right: 0.05rem;
  vertical-align: -0.15rem;

  &::before {
    text-transform: uppercase;

    // The foreground glyph
    font-family: "EBGaramondInitialsF2", serif;
    color: var(--dark);
    content: attr(data-first-letter);
    position: absolute;
  }
}

article[data-use-dropcap="true"] {
  --dropcap-vertical-offset: 0.15rem;
  --dropcap-font-size: 3.95rem;

  & > p:first-of-type {
    position: relative;
    min-height: 4.2rem;
  }

  & > p:first-of-type::before {
    content: attr(data-first-letter);
    text-transform: uppercase;
    position: absolute;
    top: var(--dropcap-vertical-offset);
    left: 0;
    font-size: var(--dropcap-font-size);
    line-height: 1;
    padding-right: 0.1em;
    font-family: "EBGaramondInitialsF2", serif;
  }

  & > p:first-of-type::first-letter {
    padding-top: var(--dropcap-vertical-offset);
    text-transform: uppercase;
    font-style: normal !important;
    float: left;
    pointer-events: none; /* Ensure it doesn't interfere with user interactions */
    color: var(--lightgray);
    font-size: var(--dropcap-font-size);
    line-height: 1;
    padding-right: 0.1em;
    font-family: "EBGaramondInitialsF1", serif;
    font-weight: 500 !important;
  }

  & > p:first-of-type::first-line {
    font-family: EBGaramondSC, serif !important;
  }

  & > p:first-of-type em,
  & > p:first-of-type b,
  & > p:first-of-type strong {
    font-family: inherit !important;
  }

  & > p:first-of-type .small-caps {
    font-family: EBGaramondSC, serif !important;
  }

  & > p[data-first-letter="f"]::before,
  & > p[data-first-letter="F"]::before {
    padding-left: 0.025em;
  }
}

// Add indent after the first line
.center li,
#backlinks li,
.popover-inner li {
  text-indent: calc(-0.25 * $base-margin);
}

// Make sure the bullet points don't feel choked
.center li,
.popover-inner li {
  margin-bottom: calc(0.5 * $base-margin);
}

#backlinks {
  position: relative;

  & li {
    &::marker {
      color: var(--lightgray);
    }

    & a {
      text-decoration-thickness: 0.2px;
      background-color: transparent;
      color: var(--gray);
    }
  }
}

// Mermaid
// stylelint-disable-next-line selector-class-pattern
.edgeLabel > div, // stylelint-disable-next-line 
.edgeLabel > p {
  align-items: baseline !important;
  background-color: transparent !important;
}

.flowchart {
  display: block !important; // Allows the diagram to be centered
  margin-left: auto;
  margin-right: auto;
}

.cluster {
  & rect {
    transform: translateY(calc(-0.5 * $base-margin));
  }

  & .cluster-label {
    text-decoration: underline; // Bolding makes the width too small
  }
}

// Edge labels  - TODO not working on safari
// stylelint-disable-next-line selector-class-pattern
.edgeLabel > .label > foreignObject {
  overflow: visible !important;

  & > div {
    background-color: transparent !important;
    padding: 0 !important;

    // stylelint-disable-next-line
    &:has(.edgeLabel:empty) {
      display: none !important;
      background-color: transparent !important;
    }
  }
}

.label span {
  color: var(--dark) !important;
}

.flowchart-link {
  stroke: var(--lightgray) !important;
}

.flowchart p,
.flowchart .katex {
  // NOTE hacky, unlike commit 22939c1 we render mermaid on the server. so some of the settings are different and we have to compensate.
  font-size: 16px !important;
}

.manifold-embed {
  position: relative;
  width: 100%;
  height: 18rem;
  max-width: 35rem;
  border-radius: 5px;
}

.after-article-components {
  margin-bottom: calc(2 * $base-margin);
  margin-top: calc(2 * $base-margin);

  & p {
    margin-bottom: $base-margin; // Less separation than usual
  }
}

#subscription-and-contact {
  border-radius: 5px;
  border: 1px solid var(--gray);
  padding-bottom: 1rem;
  padding-left: 1rem;
  padding-right: 1rem;
  max-width: fit-content;
  margin-left: auto;
  margin-right: auto;
}

// Date formatting
.ordinal-suffix {
  vertical-align: 0.3em;
  margin-left: 0.05em;
  text-decoration: underline;
  text-decoration-thickness: 1.25px !important;
  text-decoration-color: var(--lightgray) !important;
}

// Indent various elements of the sidebar
#toc-content ul,
#toc-content-mobile ul {
  --text-indent-multiplier: -0.75;

  text-indent: calc(var(--text-indent-multiplier) * $base-margin);
  margin-left: calc(1 * $base-margin - $base-margin * var(--text-indent-multiplier));
}

.tags li,
.callout-metadata .callout-content > p,
#post-statistics p {
  text-indent: calc(-0.75 * $base-margin);
  margin-left: calc($base-margin);
}

iframe {
  border: none;
  width: 95%;
  border-radius: 5px;

  :root[saved-theme="light"] & {
    mix-blend-mode: multiply;
  }
}

// Arrows are too high up by default
.right-arrow {
  vertical-align: -0.0612rem;
}

// Specific graph in design doc has too much whitespace in light
:root[saved-theme="light"] {
  .compression-ratio-graph {
    margin-bottom: -0.25rem;
  }
}

#emoji-comparison {
  div {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  img {
    width: min(100px, 12vw);
    aspect-ratio: 1;
    object-fit: contain;
    margin: 0 auto;
  }

  .subfigure {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
}
